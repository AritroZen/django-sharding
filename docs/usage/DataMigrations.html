
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Data Migrations Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../advanced/" />
    
    
    <link rel="prev" href="Migrations.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Table of Contents</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Read Me
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../components/">
            
                <a href="../components/">
            
                    
                    Components
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../components/IDGeneration.html">
            
                <a href="../components/IDGeneration.html">
            
                    
                    ID Generation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../components/ShardingFunctions.html">
            
                <a href="../components/ShardingFunctions.html">
            
                    
                    Sharding Functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../components/ReadStrategies.html">
            
                <a href="../components/ReadStrategies.html">
            
                    
                    Read Strategies
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../components/Router.html">
            
                <a href="../components/Router.html">
            
                    
                    The Router
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../components/OtherComponents.html">
            
                <a href="../components/OtherComponents.html">
            
                    
                    Other Components
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../installation/">
            
                <a href="../installation/">
            
                    
                    Installation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../installation/HowToShard.html">
            
                <a href="../installation/HowToShard.html">
            
                    
                    Choosing How To Shard
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../installation/Settings.html">
            
                <a href="../installation/Settings.html">
            
                    
                    Settings
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="./">
            
                <a href="./">
            
                    
                    Usage
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="AnotherDB.html">
            
                <a href="AnotherDB.html">
            
                    
                    Store Models on Another DB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="ShardingAModel.html">
            
                <a href="ShardingAModel.html">
            
                    
                    Sharding A Model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="Migrations.html">
            
                <a href="Migrations.html">
            
                    
                    Model Migration
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.4" data-path="DataMigrations.html">
            
                <a href="DataMigrations.html">
            
                    
                    Data Migrations
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../advanced/">
            
                <a href="../advanced/">
            
                    
                    Advanced Topics
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../advanced/ReplicationLag.html">
            
                <a href="../advanced/ReplicationLag.html">
            
                    
                    Replication Lag
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../advanced/Rebalancing.html">
            
                <a href="../advanced/Rebalancing.html">
            
                    
                    Shard Rebalancing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../../CHANGES.md">
            
                <span>
            
                    
                    Change Log
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Data Migrations</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="creating-data-migrations">Creating Data Migrations</h1>
<p>In order to remain compatible with Django, the way to specify which databases to run the migration on, it will be selected based
on what hints (if any) are passed by <code>RunPython</code>.</p>
<h3 id="case-1-no-hints">case 1: No hints</h3>
<p>The following code will execute on each database that has at least one model in the app where the migration is stored.
You will need to take this into account when writing your python code, as int he example below.</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> unicode_literals

<span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> migrations

<span class="hljs-keyword">from</span> django_sharding_library.utils <span class="hljs-keyword">import</span> is_model_class_on_database


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">do_the_stuff</span><span class="hljs-params">(apps, schema_editor)</span>:</span>
  User = apps.get_model(<span class="hljs-string">&quot;auth&quot;</span>, <span class="hljs-string">&quot;User&quot;</span>)
  current_database = schema_editor.connection.alias

  <span class="hljs-keyword">if</span> is_model_class_on_database(model=User, database=database):
      User.objects.using(database).update(password=<span class="hljs-string">&quot;*******&quot;</span>)


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Migration</span><span class="hljs-params">(migrations.Migration)</span>:</span>

    dependencies = [
        (<span class="hljs-string">&apos;auth&apos;</span>, <span class="hljs-string">&apos;__first__&apos;</span>),
    ]

    operations = [
        migrations.RunPython(
            do_the_stuff, hints={}
        ),
    ]
</code></pre>
<h3 id="case-2-modelname-passed-in-hints">case 2: <code>model_name</code> passed in hints</h3>
<p>The following code will execute on each database that has the <code>User</code> model on it.</p>
<p>The format is to pass it in as a string of <code>&lt;app_name&gt;.&lt;model_name&gt;</code>, e.g. <code>auth.User</code>.</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> unicode_literals

<span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> migrations


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">do_the_stuff</span><span class="hljs-params">(apps, schema_editor)</span>:</span>
    User = apps.get_model(<span class="hljs-string">&quot;auth&quot;</span>, <span class="hljs-string">&quot;User&quot;</span>)
    current_database = schema_editor.connection.alias

    User.objects.using(database).update(password=<span class="hljs-string">&quot;*******&quot;</span>)


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Migration</span><span class="hljs-params">(migrations.Migration)</span>:</span>

    dependencies = [
        (<span class="hljs-string">&apos;auth&apos;</span>, <span class="hljs-string">&apos;__first__&apos;</span>),
    ]

    operations = [
        migrations.RunPython(
            do_the_stuff, hints={<span class="hljs-string">&apos;model_name&apos;</span>: settings.AUTH_USER_MODEL}
        ),
    ]
</code></pre>
<h3 id="case-3-forcemigrateondatabases-passed-in-hints">case 3: <code>force_migrate_on_databases</code> passed in hints</h3>
<p>In order to allow for custom behaviour as there is no way to force <code>Django</code> to migrate on
a specific set of databases during <code>migrate</code>. It will noop on databases which it <em>things</em> do not
need the migration. This is a way around that.</p>
<p>The following code will execute on each database in the <code>force_migrate_on_databases</code> list.
You will need to take this into account when writing your python code, as in the example below.</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> unicode_literals

<span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> migrations

<span class="hljs-keyword">from</span> django_sharding_library.utils <span class="hljs-keyword">import</span> is_model_class_on_database


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">do_the_stuff</span><span class="hljs-params">(apps, schema_editor)</span>:</span>
  User = apps.get_model(<span class="hljs-string">&quot;auth&quot;</span>, <span class="hljs-string">&quot;User&quot;</span>)
  current_database = schema_editor.connection.alias

  <span class="hljs-keyword">if</span> is_model_class_on_database(model=User, database=database):
      User.objects.using(database).update(password=<span class="hljs-string">&quot;*******&quot;</span>)


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Migration</span><span class="hljs-params">(migrations.Migration)</span>:</span>

    dependencies = [
        (<span class="hljs-string">&apos;auth&apos;</span>, <span class="hljs-string">&apos;__first__&apos;</span>),
    ]

    operations = [
        migrations.RunPython(
            do_the_stuff, hints={<span class="hljs-string">&apos;force_migrate_on_databases&apos;</span>: [<span class="hljs-string">&quot;database_001&quot;</span>, <span class="hljs-string">&quot;database_003&quot;</span>]}
        ),
    ]
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Migrations.html" class="navigation navigation-prev " aria-label="Previous page: Model Migration">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../advanced/" class="navigation navigation-next " aria-label="Next page: Advanced Topics">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Data Migrations","level":"1.4.4","depth":2,"next":{"title":"Advanced Topics","level":"1.5","depth":1,"path":"docs/advanced/README.md","ref":"docs/advanced/README.md","articles":[{"title":"Replication Lag","level":"1.5.1","depth":2,"path":"docs/advanced/ReplicationLag.md","ref":"docs/advanced/ReplicationLag.md","articles":[]},{"title":"Shard Rebalancing","level":"1.5.2","depth":2,"path":"docs/advanced/Rebalancing.md","ref":"docs/advanced/Rebalancing.md","articles":[]}]},"previous":{"title":"Model Migration","level":"1.4.3","depth":2,"path":"docs/usage/Migrations.md","ref":"docs/usage/Migrations.md","articles":[]},"dir":"ltr"},"config":{"plugins":["search"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"search":{},"highlight":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"links":{},"gitbook":"3.x.x"},"file":{"path":"docs/usage/DataMigrations.md","mtime":"2016-10-07T21:49:12.000Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2016-10-07T22:10:52.928Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

