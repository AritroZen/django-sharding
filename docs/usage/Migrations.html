
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Model Migration Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="DataMigrations.html" />
    
    
    <link rel="prev" href="ShardingAModel.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Table of Contents</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Read Me
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../components/">
            
                <a href="../components/">
            
                    
                    Components
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../components/IDGeneration.html">
            
                <a href="../components/IDGeneration.html">
            
                    
                    ID Generation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../components/ShardingFunctions.html">
            
                <a href="../components/ShardingFunctions.html">
            
                    
                    Sharding Functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../components/ReadStrategies.html">
            
                <a href="../components/ReadStrategies.html">
            
                    
                    Read Strategies
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../components/Router.html">
            
                <a href="../components/Router.html">
            
                    
                    The Router
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../components/OtherComponents.html">
            
                <a href="../components/OtherComponents.html">
            
                    
                    Other Components
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../installation/">
            
                <a href="../installation/">
            
                    
                    Installation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../installation/HowToShard.html">
            
                <a href="../installation/HowToShard.html">
            
                    
                    Choosing How To Shard
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../installation/Settings.html">
            
                <a href="../installation/Settings.html">
            
                    
                    Settings
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="./">
            
                <a href="./">
            
                    
                    Usage
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="AnotherDB.html">
            
                <a href="AnotherDB.html">
            
                    
                    Store Models on Another DB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="ShardingAModel.html">
            
                <a href="ShardingAModel.html">
            
                    
                    Sharding A Model
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.3" data-path="Migrations.html">
            
                <a href="Migrations.html">
            
                    
                    Model Migration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="DataMigrations.html">
            
                <a href="DataMigrations.html">
            
                    
                    Data Migrations
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../advanced/">
            
                <a href="../advanced/">
            
                    
                    Advanced Topics
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../advanced/ReplicationLag.html">
            
                <a href="../advanced/ReplicationLag.html">
            
                    
                    Replication Lag
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../advanced/Rebalancing.html">
            
                <a href="../advanced/Rebalancing.html">
            
                    
                    Shard Rebalancing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../../CHANGES.md">
            
                <span>
            
                    
                    Change Log
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Model Migration</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="creating--running-model-migrations">Creating &amp; Running Model Migrations</h1>
<p>In order to make running migrations easier, a new migration command is included with the package when you add <code>django_sharding</code> to your <code>INSTALLED_APPS</code> list in your settings file. The net effect is that calling <code>python manage.py migrate</code> or <code>python manage.py makemigrations</code> will work as they did before for all model migrations.</p>
<p>Here&apos;s how the old command was wrapped to handle sharding:</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> django.core.management.commands.migrate <span class="hljs-keyword">import</span> Command <span class="hljs-keyword">as</span> MigrationCommand

<span class="hljs-keyword">from</span> django_sharding_library.exceptions <span class="hljs-keyword">import</span> InvalidMigrationException


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Command</span><span class="hljs-params">(MigrationCommand)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle</span><span class="hljs-params">(self, *args, **options)</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;
        Wrap the original command and runs migrate on all the databases. When
        a migration is run on a DB it is not supposed to migrate, the router
        detects this and performs no actions on that database. Each database
        tracks its own history of migrations so that you can run them on a
        specific database at a time.
        &quot;&quot;&quot;</span>

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options[<span class="hljs-string">&apos;database&apos;</span>] <span class="hljs-keyword">or</span> options[<span class="hljs-string">&apos;database&apos;</span>] == <span class="hljs-string">&apos;all&apos;</span>:
            databases = self.get_all_but_replica_dbs()
        <span class="hljs-keyword">elif</span> options[<span class="hljs-string">&apos;database&apos;</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.get_all_but_replica_dbs():
            <span class="hljs-keyword">raise</span> InvalidMigrationException(
                <span class="hljs-string">&apos;You must migrate an existing non-primary DB.&apos;</span>
            )
        <span class="hljs-keyword">else</span>:
            databases = [options[<span class="hljs-string">&apos;database&apos;</span>]]

        <span class="hljs-keyword">for</span> database <span class="hljs-keyword">in</span> databases:
            options[<span class="hljs-string">&apos;database&apos;</span>] = database
            <span class="hljs-comment"># Writen in green text to stand out from the surrouding headings</span>
            <span class="hljs-keyword">if</span> options[<span class="hljs-string">&apos;verbosity&apos;</span>] &gt;= <span class="hljs-number">1</span>:
                self.stdout.write(self.style.MIGRATE_SUCCESS(
                    <span class="hljs-string">&quot;\nDatabase: {}\n&quot;</span>).format(database)
                )
            super(Command, self).handle(*args, **options)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_all_but_replica_dbs</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;
        Return a list of primary databases, used to prevent migrations from
        being run on replication databases.
        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> list(filter(
            <span class="hljs-keyword">lambda</span> db: <span class="hljs-keyword">not</span> settings.DATABASES[db].get(<span class="hljs-string">&apos;PRIMARY&apos;</span>, <span class="hljs-keyword">None</span>),
            settings.DATABASES.keys()
        ))

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_arguments</span><span class="hljs-params">(self, parser)</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;
        Overrides the existing Database command to accept any primary database as
        well as the keywork `all` which is the new default value.
        &quot;&quot;&quot;</span>
        super(Command, self).add_arguments(parser)
        parser._option_string_actions[<span class="hljs-string">&apos;--database&apos;</span>].default = <span class="hljs-keyword">None</span>
        parser._option_string_actions[<span class="hljs-string">&apos;--database&apos;</span>].help = (
            <span class="hljs-string">u&apos;Nominates a database to synchronize. Defaults to all databases.&apos;</span>
        )
        parser._option_string_actions[<span class="hljs-string">&apos;--database&apos;</span>].choices = (
            [<span class="hljs-string">&apos;all&apos;</span>] + self.get_all_but_replica_dbs()
        )
</code></pre>
<p>By using the included router, it&apos;s as simple as calling migrate on all the primary databases in the system and allowing the system to decide which databases to run the migration on. The above changes were made to make the interface more simple than having to specify all the relevant databases.</p>
<h3 id="postgresshardgeneratedidfield-migration-info">PostgresShardGeneratedIDField Migration Info</h3>
<p>This library hooks into the Django migrations and creates (or updates) the necessary stored procedures before every migration. We made it work this way for two reasons:</p>
<ol>
<li>Django does not have a good way to force a field-specific migration dependency without having to edit the migration files themselves after they are generated</li>
<li>This allows unit tests to be run on any arbitrary (PostgreSQL) database without any administrative overhead.</li>
</ol>
<p>The migration hooks should not affect you in any way, but you should be aware that there is a little bit of &quot;magic&quot; going on to make this field work with Django&apos;s migrations, without actually being part of the migration file itself.</p>
<p>If the Django team ever makes migrations easier to customize by adding dependency injection based on specific fields, we will update this and add the migration step to your migration files when they are generated!</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="ShardingAModel.html" class="navigation navigation-prev " aria-label="Previous page: Sharding A Model">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="DataMigrations.html" class="navigation navigation-next " aria-label="Next page: Data Migrations">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Model Migration","level":"1.4.3","depth":2,"next":{"title":"Data Migrations","level":"1.4.4","depth":2,"path":"docs/usage/DataMigrations.md","ref":"docs/usage/DataMigrations.md","articles":[]},"previous":{"title":"Sharding A Model","level":"1.4.2","depth":2,"path":"docs/usage/ShardingAModel.md","ref":"docs/usage/ShardingAModel.md","articles":[]},"dir":"ltr"},"config":{"plugins":["search"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"search":{},"highlight":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"links":{},"gitbook":"3.x.x"},"file":{"path":"docs/usage/Migrations.md","mtime":"2016-10-07T21:49:12.000Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2016-10-07T22:10:52.928Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

