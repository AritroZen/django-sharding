<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Sharding Functions &#8212; Django Sharding 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="ReadStrategies.html" />
    <link rel="prev" title="ID Generation" href="IDGeneration.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="sharding-functions">
<h1>Sharding Functions<a class="headerlink" href="#sharding-functions" title="Permalink to this headline">¶</a></h1>
<p>A sharding function is a python class that will choose which data belongs on
which database and let us know which database the stored data is on.</p>
<p>This is split into the two functions <cite>pick_shard</cite> and <cite>get_shard</cite> on a plain
python class. The reason this is split into two different functions is that
there are common sharding functions used that are not deterministic. Since the
generator may be non deterministic then both are implemented separately. An
example of this is to round-robin bucket users into their own shards.</p>
<p>An interface for a sharding strategy looks as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseBucketingStrategy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shard_group</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shard_group</span> <span class="o">=</span> <span class="n">shard_group</span>

    <span class="k">def</span> <span class="nf">get_shards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databases</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">name</span> <span class="k">for</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> <span class="ow">in</span> <span class="n">databases</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SHARD_GROUP&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_group</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">pick_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_sharded_by</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the shard for the model which has not previously</span>
<span class="sd">        been bucketed into a shard.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">get_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_sharded_by</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the shard for a model which has already been</span>
<span class="sd">        assigned a shard.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span>
</pre></div>
</div>
<p>As I mentioned above, there are are both deterministic and non-deterministic
ways of bucketing into shards. As an example below, I will show the ones
included wit the package.</p>
<div class="section" id="deterministic-functions">
<h2>Deterministic Functions<a class="headerlink" href="#deterministic-functions" title="Permalink to this headline">¶</a></h2>
<p>I have not shipped this package with any truly deterministic functions as I&#8217;ve
yet to come across a need and the example below is brittle as it breaks as soon
as you add more shards to the system. Nonetheless, I have included it for
completeness.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ModBucketingStrategy</span><span class="p">(</span><span class="n">BaseBucketingStrategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A shard selection strategy that assigns shards based on the mod</span>
<span class="sd">    of the models pk.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shard_group</span><span class="p">,</span> <span class="n">databases</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RoundRobinBucketingStrategy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">shard_group</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shards</span><span class="p">(</span><span class="n">databases</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pick_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_sharded_by</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">[</span>
            <span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model_sharded_by</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_sharded_by</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pick_shard</span><span class="p">(</span><span class="n">model_sharded_by</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="non-deterministic-functions">
<h2>Non-deterministic Functions<a class="headerlink" href="#non-deterministic-functions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="random-bucketing-strategy">
<h3>Random Bucketing Strategy<a class="headerlink" href="#random-bucketing-strategy" title="Permalink to this headline">¶</a></h3>
<p>As the name says, this method chooses a random shard and ends up storing it on
the model in question.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RandomBucketingStrategy</span><span class="p">(</span><span class="n">BaseShardedModelBucketingStrategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A shard selection strategy that assigns shards randomly.</span>
<span class="sd">    This is non-deterministic and this strategy assumes the shard</span>
<span class="sd">    is saved to the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shard_group</span><span class="p">,</span> <span class="n">databases</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RoundRobinBucketingStrategy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">shard_group</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shards</span><span class="p">(</span><span class="n">databases</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pick_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_sharded_by</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_sharded_by</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model_sharded_by</span><span class="o">.</span><span class="n">shard</span>
</pre></div>
</div>
</div>
<div class="section" id="round-robin-bucketing-strategy">
<h3>Round-Robin Bucketing Strategy<a class="headerlink" href="#round-robin-bucketing-strategy" title="Permalink to this headline">¶</a></h3>
<p>This uses a round-robin approach to choose a shard in order to maintain a
balance across the system so that the proportion of new instances is even
across the shards:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RoundRobinBucketingStrategy</span><span class="p">(</span><span class="n">BaseShardedModelBucketingStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shard_group</span><span class="p">,</span> <span class="n">databases</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RoundRobinBucketingStrategy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">shard_group</span>
        <span class="p">)</span>

        <span class="n">shards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shards</span><span class="p">(</span><span class="n">databases</span><span class="p">)</span>
        <span class="n">max_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shards</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">starting_index</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_index</span><span class="p">)</span>

        <span class="n">shards</span> <span class="o">=</span> <span class="n">shards</span><span class="p">[</span><span class="n">starting_index</span><span class="p">:]</span> <span class="o">+</span> <span class="n">shards</span><span class="p">[:</span><span class="n">starting_index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shards_cycle</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">shards</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pick_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_sharded_by</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shards_cycle</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_sharded_by</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model_sharded_by</span><span class="o">.</span><span class="n">shard</span>
</pre></div>
</div>
<p>Since this is initialized at app initialization time, it begins the cycle at a
random index, otherwise the first shard would always be imbalanced.</p>
</div>
<div class="section" id="mod-bucketing-strategy">
<h3>Mod Bucketing Strategy<a class="headerlink" href="#mod-bucketing-strategy" title="Permalink to this headline">¶</a></h3>
<p>This works the same way as the non-deterministic strategy but allows you to add
shards by storing them on the model.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ModBucketingStrategy</span><span class="p">(</span><span class="n">BaseBucketingStrategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A shard selection strategy that assigns shards based on the mod of the</span>
<span class="sd">    models pk.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shard_group</span><span class="p">,</span> <span class="n">databases</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RoundRobinBucketingStrategy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">shard_group</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shards</span><span class="p">(</span><span class="n">databases</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pick_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_sharded_by</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">[</span>
            <span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model_sharded_by</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shards</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_sharded_by</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model_sharded_by</span><span class="o">.</span><span class="n">shard</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Sharding Functions</a><ul>
<li><a class="reference internal" href="#deterministic-functions">Deterministic Functions</a></li>
<li><a class="reference internal" href="#non-deterministic-functions">Non-deterministic Functions</a><ul>
<li><a class="reference internal" href="#random-bucketing-strategy">Random Bucketing Strategy</a></li>
<li><a class="reference internal" href="#round-robin-bucketing-strategy">Round-Robin Bucketing Strategy</a></li>
<li><a class="reference internal" href="#mod-bucketing-strategy">Mod Bucketing Strategy</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="IDGeneration.html" title="previous chapter">ID Generation</a></li>
      <li>Next: <a href="ReadStrategies.html" title="next chapter">&lt;no title&gt;</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/components/ShardingFunctions.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Joseph Kahn.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="../_sources/components/ShardingFunctions.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>