<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ID Generation &#8212; Django Sharding 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="ShardingFunctions.html" />
    <link rel="prev" title="Welcome to Django Sharding’s documentation!" href="../index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id-generation">
<h1>ID Generation<a class="headerlink" href="#id-generation" title="Permalink to this headline">¶</a></h1>
<p>When sharding your data there are a few important upfront decisions to make, one
of the most important ones is how identify each of your models. There are several
common strategies and this library allows you to configure this yourself if you
know the strategy you&#8217;d like to use.</p>
<p>The reason this becomes important is that once you pick a strategy, those ids
will be used in your foreign keys and it will be difficult to change. There
are a few common strategies, most of which come shipped with the package.</p>
<div class="section" id="unique-shard-ids-generated-using-the-time">
<h2>1) Unique shard IDs generated using the time<a class="headerlink" href="#unique-shard-ids-generated-using-the-time" title="Permalink to this headline">¶</a></h2>
<p>This strategy uses a 64 bit integer to encode the time the item was created, the
shard it was created on and a counter. It works by creating a counter on each of
the shards. It allows you to store as many unique combinations of time,
shard and counter as can fit in that 64 bit integer, which is 1000 per shard per
millisecond.</p>
<p>i.e. the integer 3863625104385</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>

<span class="nb">id</span> <span class="o">=</span> <span class="mi">3863625104385</span>

<span class="n">date_created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(((</span><span class="nb">id</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1476914064192</span><span class="p">)</span><span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
<span class="c1"># datetime.datetime(2016, 10, 19, 18, 2, 4, 772000)</span>

<span class="n">counter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="nb">id</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:],</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># 1st object created</span>

<span class="n">shard</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="nb">id</span><span class="p">)[</span><span class="o">-</span><span class="mi">23</span><span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># 31st shard</span>
</pre></div>
</div>
<p>This method supports up to 8192 shards (13 bits) and up to 1024 inserts per
millisecond (10 bits). this should be more than enough for most use cases as
it has been used in places like Instagram where scale is an issue.</p>
<p>Note: While I have only included the Postgres implimentation of this so far, it is not
difficult to adapt this for other databases (PRs welcome!).</p>
</div>
<div class="section" id="use-a-uuid-shard-id-combination">
<h2>2) Use a UUID &amp; shard id combination<a class="headerlink" href="#use-a-uuid-shard-id-combination" title="Permalink to this headline">¶</a></h2>
<p>This is a much simpler route and has the benefit of being easier to understand
as each of the ids is just a concatenation or a uuid and a shard&#8217;s id. The
downside to this approach is that if you ever needed to move a record from one
database to another, there can be uuid collisions (even if those are fairly
unlikely).</p>
</div>
<div class="section" id="use-a-simple-integer">
<h2>3) Use a simple integer<a class="headerlink" href="#use-a-simple-integer" title="Permalink to this headline">¶</a></h2>
<p>Instead of generating more complicated IDs, if we use a counter or sequence on
the main database to generate the IDs then we can use an integer to have unique
IDs across all the shards as the counter&#8217;s increment is atomic and thus we have
no issues with collisions. Note: I have not included this implementation in the
package yet.</p>
<p>The included implementation of this uses a table on the main database rather
than a counter to proxy the auto incrementing field&#8217;s counter. This was included
as this package was created in part to replace an existing system that worked
this way.</p>
</div>
<div class="section" id="writing-your-own">
<h2>Writing Your Own<a class="headerlink" href="#writing-your-own" title="Permalink to this headline">¶</a></h2>
<p>When writing your own, you must provide a class with a <cite>get_next_id</cite> method on
it. There are no other specific requirements, as you can also implement the
caller and provide any args needed.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseIDGenerationStrategy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A strategy for Generating unique identifiers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_next_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A function which returns a new unique identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span>
</pre></div>
</div>
</div>
<div class="section" id="pinterest">
<h2>Pinterest<a class="headerlink" href="#pinterest" title="Permalink to this headline">¶</a></h2>
<p>They recently wrote a <a class="reference external" href="https://engineering.pinterest.com/blog/sharding-pinterest-how-we-scaled-our-mysql-fleet">lovely article</a>
about their sharding strategy. They use a 64 bit ID that works like so:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_item_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">local_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name_to_id_map</span><span class="p">[</span><span class="n">database</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">46</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_to_id_map</span><span class="p">[</span><span class="n">model_class</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">36</span><span class="p">)</span> <span class="o">|</span>
        <span class="p">(</span><span class="n">local_id</span> <span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">get_info_from_item_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">):</span>
    <span class="n">database_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">item_id</span> <span class="o">&gt;&gt;</span> <span class="mi">46</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>
    <span class="n">model_id</span>  <span class="o">=</span> <span class="p">(</span><span class="n">item_id</span> <span class="o">&gt;&gt;</span> <span class="mi">36</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span>
    <span class="n">local_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">item_id</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFF</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_id_to_name_map</span><span class="p">[</span><span class="n">database_id</span><span class="p">],</span>
        <span class="n">model_id_to_class_map</span><span class="p">[</span><span class="n">model_id</span><span class="p">],</span>
        <span class="n">local_id</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>By using the above method to reference items, you need not choose an explicit ID
generation method and instead the <cite>local_id</cite> can simply by an autoincrementing
field on that table.</p>
<p>That field would look something like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ShardedLocalIDField</span><span class="p">(</span><span class="n">ShardedIDFieldMixin</span><span class="p">,</span> <span class="n">AutoField</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ShardedLocalIDField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pk_value_on_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">AutoField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_pk_value_on_save</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</pre></div>
</div>
<p>While I have not included all of the code required to use this type of sharding
strategy, this may be accomplished using this library.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">ID Generation</a><ul>
<li><a class="reference internal" href="#unique-shard-ids-generated-using-the-time">1) Unique shard IDs generated using the time</a></li>
<li><a class="reference internal" href="#use-a-uuid-shard-id-combination">2) Use a UUID &amp; shard id combination</a></li>
<li><a class="reference internal" href="#use-a-simple-integer">3) Use a simple integer</a></li>
<li><a class="reference internal" href="#writing-your-own">Writing Your Own</a></li>
<li><a class="reference internal" href="#pinterest">Pinterest</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../index.html" title="previous chapter">Welcome to Django Sharding&#8217;s documentation!</a></li>
      <li>Next: <a href="ShardingFunctions.html" title="next chapter">&lt;no title&gt;</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/components/IDGeneration.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Joseph Kahn.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="../_sources/components/IDGeneration.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>